<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Booking Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 24px; }
    #calendar { max-width: 900px; margin: 0 auto; }
    #form { max-width: 600px; margin: 20px auto; text-align: center; }
    input, select, textarea { padding: 8px; margin: 6px; width: 90%; max-width: 380px; box-sizing: border-box; }
    button { padding: 8px 16px; }
  </style>
</head>
<body>
  <h1 style="text-align:center">Booking Calendar</h1>
  <div id="calendar"></div>

  <div id="form">
    <h2>Book a slot</h2>
    <form id="bookingForm" method="POST" action="YOUR_APPS_SCRIPT_WEB_APP_URL" target="hidden_iframe">
      <input name="name" id="name" placeholder="Your name" required><br>
      <input name="email" id="email" type="email" placeholder="Your email" required><br>
      <input name="date" id="date" placeholder="Date (click a day)" readonly required><br>
      <select name="time" id="time" required>
        <!-- times will be injected -->
      </select><br>
      <textarea name="notes" id="notes" placeholder="Notes (optional)"></textarea><br>
      <button type="submit">Submit Booking</button>
    </form>
    <p id="status" style="color:green"></p>
  </div>

  <!-- hidden iframe for form posts -->
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <script>
    // CONFIG
    const API_URL = 'YOUR_APPS_SCRIPT_WEB_APP_URL'; // replace
    // Standard daily timeslots (adjust as needed)
    const AVAILABLE_TIMES = ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00'];

    // runtime state
    let bookedSlots = {}; // keys: "YYYY-MM-DD_HH:MM" -> booking info
    let calendar;

    // JSONP loader for bookings
    function loadBookings() {
      // remove previous JSONP script if present
      const old = document.getElementById('jsonpBookings');
      if (old) old.remove();

      // callback function that the server will call
      window.handleSlots = function(data) {
        bookedSlots = data && data.booked ? data.booked : {};
        refreshCalendarAndTimes();
      };

      const script = document.createElement('script');
      script.id = 'jsonpBookings';
      script.src = API_URL + '?callback=handleSlots&nocache=' + Date.now();
      document.head.appendChild(script);
    }

    // Initialize FullCalendar
    function initCalendar() {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        dateClick: function(info) {
          // fill the date input
          document.getElementById('date').value = info.dateStr;
          populateTimesForDate(info.dateStr);
          // scroll to form
          window.scrollTo({ top: document.getElementById('form').offsetTop - 20, behavior: 'smooth' });
        }
      });
      calendar.render();
      loadBookings();
    }

    // Rebuild events from bookedSlots, and refresh calendar display
    function refreshCalendarAndTimes() {
      // remove existing events and add new ones
      calendar.getEvents().forEach(ev => ev.remove());
      for (const key in bookedSlots) {
        const parts = key.split('_');
        if (parts.length !== 2) continue;
        const date = parts[0];
        const time = parts[1];
        // create a datetime string for FullCalendar
        const dt = date + 'T' + time + ':00';
        calendar.addEvent({
          title: 'Booked',
          start: dt,
          allDay: false,
          display: 'background'
        });
      }
      // refresh time dropdown for currently selected date (if any)
      const curDate = document.getElementById('date').value;
      if (curDate) populateTimesForDate(curDate);
    }

    // Populate time <select> disabling already-booked times
    function populateTimesForDate(dateStr) {
      const sel = document.getElementById('time');
      sel.innerHTML = '';
      AVAILABLE_TIMES.forEach(t => {
        const key = `${dateStr}_${t}`;
        const option = document.createElement('option');
        option.value = t;
        option.textContent = bookedSlots[key] ? `${t} — UNAVAILABLE` : `${t} — available`;
        option.disabled = !!bookedSlots[key];
        sel.appendChild(option);
      });
    }

    // Intercept form submit to do a quick double-book check using current bookedSlots
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const key = `${date}_${time}`;
      if (bookedSlots[key]) {
        e.preventDefault();
        alert('That slot is already taken. Please choose another one.');
        populateTimesForDate(date);
        return false;
      }
      // show submitting message
      document.getElementById('status').textContent = 'Submitting...';
      // allow form to submit to hidden iframe; the Apps Script response will postMessage back
    });

    // Listen for messages from the Apps Script response (the iframe content)
    window.addEventListener('message', function(ev) {
      if (!ev.data) return;
      if (ev.data.message) {
        document.getElementById('status').textContent = ev.data.message;
      }
      // refresh bookings if success
      if (ev.data.success) {
        setTimeout(() => {
          loadBookings(); // reload the JSONP to get the latest bookings
        }, 500); // small delay to ensure sheet has been updated
      }
    }, false);

    // boot
    initCalendar();
  </script>
</body>
</html>
